name: Build iOS App

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'ios_app/**'
      - '.github/workflows/ios-build.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'ios_app/**'
  workflow_dispatch:  # Manual trigger

jobs:
  build-ios:
    runs-on: macos-14  # Apple Silicon for faster builds
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
        cache: true
        
    - name: Flutter version info
      run: flutter --version
      
    - name: Flutter dependencies
      working-directory: ios_app
      run: flutter pub get
      
    - name: Create iOS project files
      working-directory: ios_app
      run: |
        # Generate the native iOS project structure
        flutter create --platforms=ios .
        
    - name: Setup App Group entitlements
      working-directory: ios_app
      run: |
        # Create entitlements file for App Groups
        mkdir -p ios/Runner
        
        cat > ios/Runner/Runner.entitlements << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>com.apple.security.application-groups</key>
            <array>
                <string>group.com.oasth.widget</string>
            </array>
        </dict>
        </plist>
        EOF
        
        echo "âœ“ Created App Group entitlements"
        
    - name: Build iOS (unsigned)
      working-directory: ios_app
      run: |
        flutter build ios --release --no-codesign
        
    - name: Create IPA archive
      working-directory: ios_app
      run: |
        # Create the Payload directory structure
        mkdir -p Payload
        
        # Copy the .app bundle
        cp -r build/ios/iphoneos/Runner.app Payload/
        
        # Rename to OASTH Live
        # Note: The app name is set in the Flutter project
        
        # Create the IPA (which is just a ZIP file)
        zip -r OASTH-Live.ipa Payload
        
        # Cleanup
        rm -rf Payload
        
        # Show result
        ls -la OASTH-Live.ipa
        
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: oasth-live-ios
        path: ios_app/OASTH-Live.ipa
        retention-days: 30

    - name: Upload Widget Swift files (for manual setup)
      uses: actions/upload-artifact@v4
      with:
        name: widget-swift-files
        path: |
          ios_app/ios/BusWidget/
        retention-days: 30
        
  # Release job (only on tagged releases)
  release:
    needs: build-ios
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download IPA
      uses: actions/download-artifact@v4
      with:
        name: oasth-live-ios
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: OASTH-Live.ipa
        name: "OASTH Live iOS ${{ github.ref_name }}"
        body: |
          ## iOS Release
          
          Download `OASTH-Live.ipa` and sideload with:
          - [AltStore/AltServer](https://altstore.io/)
          - [Sideloadly](https://sideloadly.io/)
          - [AltLinux](https://github.com/NyaMisty/AltLinux) (for Linux)
          
          **Note:** This build is the main app without widget extension.
          Widget extension requires manual Xcode setup due to Flutter limitations.
          
          **Note:** Free Apple ID requires re-signing every 7 days.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
