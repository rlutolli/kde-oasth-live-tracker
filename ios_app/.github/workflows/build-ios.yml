name: Build iOS App

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'ios_app/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'ios_app/**'
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
        cache: true
        
    - name: Flutter dependencies
      working-directory: ios_app
      run: flutter pub get
      
    - name: Create iOS project files
      working-directory: ios_app
      run: |
        flutter create --platforms=ios .
        
    - name: Setup Widget Extension
      working-directory: ios_app
      run: |
        # Copy widget Swift files to proper location
        mkdir -p ios/BusWidget
        cp -r ios/BusWidget/* ios/Runner/../BusWidget/ 2>/dev/null || true
        
    - name: Build iOS (unsigned IPA)
      working-directory: ios_app
      run: |
        flutter build ios --release --no-codesign
        
    - name: Create IPA archive
      working-directory: ios_app
      run: |
        mkdir -p Payload
        cp -r build/ios/iphoneos/Runner.app Payload/
        zip -r OASTH-Live.ipa Payload
        rm -rf Payload
        
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: oasth-live-ios
        path: ios_app/OASTH-Live.ipa
        retention-days: 7
        
  # Release job (only on main branch tags)
  release:
    needs: build-ios
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download IPA
      uses: actions/download-artifact@v4
      with:
        name: oasth-live-ios
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: OASTH-Live.ipa
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
